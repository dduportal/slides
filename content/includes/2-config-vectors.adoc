[{invert}]
= Jenkins configuration vectors

{nbsp} +

//https://images.app.goo.gl/2FJcGwDAmixKy7Wk7
[.stretch]
image::outillage.jpg[]

== Direct file System manipulation

[%step]
* classical way to configure a system
* copying/updating files on the file system (JENKINS_HOME)
* Typical Ansible modules.
** copy
** template
** lineinfile
** xml

== File system vector: Pro

* easy/natural for tools like Ansible

== File system vector: Con

* lot of reverse engineering required
* stability of these undocumented configuration is not guaranteed.
** particularly plugins configuration


== Command Line Interfaces
* two types
** REST API
** Jenkins CLI


== REST API

* using HTTP requests to GET, PUT, POST and DELETE data.

[source,bash]
----
curl -X POST "<jekinsURL>/testProject/build" --user jmm:<password|token>
----

== REST API - CSRF protection
* be aware of CSRF protection (should be on, isn't it?)
** session highjacking 
** requires a token or "crumb" when using password
** not required when using an API Token 
*** since new token format

== REST API

* To learn more:
** https://wiki.jenkins.io/display/JENKINS/Remote+access+API
** https://wiki.jenkins.io/display/JENKINS/Authenticating+scripted+clients

== Jenkins CLI

* Traditional way, via the `jenkins-cli.jar`
* To list the very functions list (dependant of installed plugin):
** view it in "Manage Jenkins -> Jenkins CLI"
** or simply use "help" CLI command.

== Jenkins CLI - Classic

{nbsp} +

[source,bash]
----
java -jar jenkins-cli.jar -http -s $JENKINS_URL -auth $USERNAME:$API_token command ...
----

{nbsp} +

Much better:
[source,bash]
----
java -jar jenkins-cli.jar -http -s $JENKINS_URL -auth @FILE command ...
----

== Jenkins CLI - SSH

* A simple SSH can also be used. 
* Requires to enable the build-in SSH server and assign a port
** watch your firewalls and reverse proxy

{nbsp} +

[source,bash]
----
ssh -l jmm -i ~/.ssh/id_rsa -p 10200 my-jenkins-server help
----


== Jenkins CLI - More details

* https://jenkins.io/doc/book/managing/cli/


== Summary

[%step]
* Rich set of API
* Easy to use in Ansible for example
* Initial user and credential is a tough problem to solve
** SSH authentication can be automated
* CLI does a better job at controlling parameter
* CLI makes blocking calls
* CLI commands are better documented
* Parsing results is tricky

== Recommendation

* Use CLI
* Use CLI with SSH if you can (networking)
* Consider executing commands from target host.

== BONUS - how to retrieve a token

[source,bash]
----
# First thing we do is obtain a crumb from cjoc, this allows us to call the rest API without having to disable CSRF.
JENKINS_CRUMB=$( \
  curl --user $USERNAME:$PASSWORD \
       --silent "$URL/cjoc/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)" \
)

# Get the JSON payload from the generateNewToken API
JENKINS_TOKENS_JSON=$( \
  curl --header "$JENKINS_CRUMB" \
       --user $USERNAME:$PASSWORD \
       --silent "$URL/cjoc/user/$USERNAME/descriptorByName/jenkins.security.ApiTokenProperty/generateNewToken" \
       --data "newTokenName=$USERNAME" \
)

# Pulls the token out of the JSON payload.
JENKINS_TOKEN=$( \
  echo $JENKINS_TOKENS_JSON | jq '.data.tokenValue' \
)

# Running Sed to get trim quotes from the output and returns it.
sed -e 's/^"//' -e 's/"$//' <<<"$JENKINS_TOKEN"
----

== Groovy Scripts

[%step]
* Richest way to configure Jenkins
** Taps into Jenkins native language 
* Need developer skills 
* Documentation not easy to find
** See this link:https://support.cloudbees.com/hc/en-us/articles/228175367-Custom-Plugins-APIs-and-Javadocs-of-CloudBees-Jenkins-Enterprise-plugins[_Knowledge Base article_,window=_blank] on how to access the javadocs
* Make them indempotent !

== How to use Groovy Script

[%step]
* via the script console
* at startup, as init-script
** placed in `$JENKINS_HOME/init.groovy.d/`
** executed in lexical order
* via the CLI

== Groovy Scripts from the CLI

{nbsp} +

[source,bash]
----
cat my_script.groovy | {{ CLI_command }} groovy =
----

== Docker Container

[%step]
* Can automate the configuration of some parts 
** ex: pre-loading plugins
* But does not solve all the problems
* a little out of the scope of this presentation

== Jenkins Configuration as Code

* First developped and tested in OSS realm
* Implementation on CloudBees product is ongoing

{nbsp} +

* Declarative method, yaml based
* Loaded on reboot or with a CLI command

== JCasC Example (LDAP cfg)

[source,yaml]
----
jenkins:
  securityRealm:
    ldap:
      configurations:
      - inhibitInferRootDN: false
        managerDN: "uid=idm,ou=Administrators,dc=example,dc=com"
        managerPasswordSecret: "{{ ldap_admin_passw }}"
        rootDN: "dc=example,dc=com"
        server: "ldap://{{ full_agent_docker_dns_name }}:389"
      disableMailAddressResolver: false
      disableRolePrefixing: true
      groupIdStrategy: "caseInsensitive"
      userIdStrategy: "caseInsensitive"
----

== JCasC Example (JNLP agent)

[source,yaml]
----
jenkins:
  nodes:
  - permanent:
      labelString: "jnlp"
      mode: NORMAL
      name: "jnlp-agent"
      remoteFS: "/home/jenkins"
      launcher:
        jnlp:
          workDirSettings:
            disabled: true
      nodeDescription: "Agent that initiates its own connection to Jenkins"
      retentionStrategy: "always"
  numExecutors: 0

----

== Current Status

* In technical preview
** Masters configuration work
** CloudBees functionality in the works
** Waiting for RBAC support
* Centralized CasC management from CJOC

