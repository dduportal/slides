[{invert}]
= Jenkins configuration vectors

{nbsp} +

//https://images.app.goo.gl/2FJcGwDAmixKy7Wk7
[.stretch]
image::outillage.jpg[]

= Direct file System manipulation

[%step]
* classical way to configure a system
* copying/updating files on the file system (JENKINS_HOME)
* Typical Ansible modules.
** copy
** template
** lineinfile
** xml

= File system vector: Pro üëç

* easy/natural for tools like Ansible

= File system vector: Con üëé

* lot of reverse engineering required
* stability of configuration is not guaranteed.
** particularly plugins configuration


= Command Line Interfaces
* two types
** REST API
** Jenkins CLI


= REST API

* using HTTP requests to GET, PUT, POST and DELETE data.

[source,bash]
----
curl -X POST "<jekinsURL>/testProject/build" --user jmm:<password|token>
----

Documentation is üòß

= REST API - CSRF protection
* be aware of CSRF protection (should be on, isn't it?)
** session hijacking 
** requires a token or "crumb" when using password
** not required when using an API Token 
*** since new token format

= REST API

* To learn more:  üìñ
** https://wiki.jenkins.io/display/JENKINS/Remote+access+API
** https://wiki.jenkins.io/display/JENKINS/Authenticating+scripted+clients

= Jenkins CLI

* Traditional way, via the `jenkins-cli.jar`
* To list the very functions list (dependant of installed plugin):
** view it in "Manage Jenkins -> Jenkins CLI"
** or simply use "help" CLI command.

= Jenkins CLI - Classic

{nbsp} +

[source,bash]
----
java -jar jenkins-cli.jar -http -s $JENKINS_URL -auth $USERNAME:$API_token command ...
----

{nbsp} +

Much better üòÉ :
[source,bash]
----
java -jar jenkins-cli.jar -http -s $JENKINS_URL -auth @FILE command ...
----

Can use file permission, easy to configure with Ansible

= Jenkins CLI - SSH

* A simple SSH client can also be used. 
* Requires to enable the built-in SSH server and assign a port
** watch your firewalls and reverse proxy

{nbsp} +

[source,bash]
----
ssh -l jmm -i ~/.ssh/id_rsa -p 10200 my-jenkins-server help
----

ü§î Can solve some of the bootstrapping problem

= Jenkins CLI - More details

* https://jenkins.io/doc/book/managing/cli/


= Summary

[%step]
* Rich set of API
* Easy to use in Ansible for example
* Initial user and credential is a tough problem to solve
** SSH authentication can be automated
* CLI does a better job at controlling parameter
* CLI makes synchonous calls
* CLI commands are better documented üòá
* Parsing results is tricky üòí

= Recommendation

* Use CLI
* Use CLI with SSH if you can (networking)
* Consider executing commands from target host (localhost).

= Groovy Scripts

[%step]
* Richest way to configure Jenkins
** Taps into Jenkins' native language 
* Need developer skills ü§ì
* Documentation not easy to find
** See this link:https://support.cloudbees.com/hc/en-us/articles/228175367-Custom-Plugins-APIs-and-Javadocs-of-CloudBees-Jenkins-Enterprise-plugins[_Knowledge Base article_,window=_blank] on how to access the javadocs
* Make them idempotent ! üëÄ

= How to use Groovy Script

[%step]
* via the script console
* at startup, as init-script
** placed in `$JENKINS_HOME/init.groovy.d/`
** executed in lexical order
* via the CLI

= Groovy Scripts from the CLI

{nbsp} +

[source,bash]
----
cat my_script.groovy | {{ CLI_command }} groovy =
----

= Docker Container

[%step]
* Can automate the configuration of some parts 
** ex: pre-loading plugins
* But does not solve all the problems
* a little out of the scope of this presentation

= Jenkins Configuration as Code

* First developed in OSS realm
* Dev for CloudBees product is ongoing

{nbsp} +

* Declarative method, yaml based
* Loaded on reboot or with a CLI command

= JCasC Example (LDAP cfg)

[source,yaml]
----
jenkins:
  securityRealm:
    ldap:
      configurations:
      - inhibitInferRootDN: false
        managerDN: "uid=idm,ou=Administrators,dc=example,dc=com"
        managerPasswordSecret: "{{ ldap_admin_passw }}"
        rootDN: "dc=example,dc=com"
        server: "ldap://{{ full_agent_docker_dns_name }}:389"
      disableMailAddressResolver: false
      disableRolePrefixing: true
      groupIdStrategy: "caseInsensitive"
      userIdStrategy: "caseInsensitive"
----

= JCasC Example (JNLP agent)

[source,yaml]
----
jenkins:
  nodes:
  - permanent:
      labelString: "jnlp"
      mode: NORMAL
      name: "jnlp-agent"
      remoteFS: "/home/jenkins"
      launcher:
        jnlp:
          workDirSettings:
            disabled: true
      nodeDescription: "Agent that initiates its own connection to Jenkins"
      retentionStrategy: "always"
  numExecutors: 0

----

= Current Status
[%step]
* In technical preview for CloudBees products
[%step]
** Masters configuration already works
** CloudBees functionality actively been worked on
** Waiting for RBAC support üòõ
* Centralized CasC management from CJOC

